<!DOCTYPE html> 
<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>SEVICI MAPA</title> 
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" /> 
<link href="{{MEDIA_URL}}css/map.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script> 
<script type="text/javascript"> 
var google;
var googleMap = function () {
  var that = this;
  var map;
  var geocoder;
  var lastWindow;
  this.initialize = function () {
    this.geocoder = new google.maps.Geocoder();
    var center = new google.maps.LatLng(37.3876493509, -5.96565525205);
    var mapOptions = {
      zoom: 14,
      center: center,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    this.loadMarkers();
  };

  this.addMarker = function (kiosk) {
    var name = kiosk.name;
    var spaces = kiosk.spaces;
    var bikes = kiosk.bikes;
    var latlng = new google.maps.LatLng(kiosk.lat, kiosk.lng);
    var image = new google.maps.MarkerImage(
       "{{MEDIA_URL}}marker/marker_" + color(bikes) +".png",
       new google.maps.Size(12, 20),
       // The origin for this image is 0,0.
       new google.maps.Point(0,0),
       // The anchor for this image is the base of the pin at 0,32.
       new google.maps.Point(0, 32));
       
     var shadow = new google.maps.MarkerImage(
        "{{MEDIA_URL}}marker/marker_shadow.png",
        //shadow is wider
        new google.maps.Size(22, 20),
        // The origin for this image is 0,0.
        new google.maps.Point(0,0),
        // The anchor for this image is the base of the pin at 0,32.
        new google.maps.Point(0, 32));
        
    var marker = new google.maps.Marker({
      position: latlng,
      map: map,
      title: name,
      icon: image,
      shadow: shadow
    });

    var contentString = "<div class='marker_title'>" + name + "</div>" + 
    "<div class='marker_content'>" + "<p>bikes available: " + bikes + "</p>" +
    "<p>spaces available: " + spaces + "</p>";

    var infoWindow = new google.maps.InfoWindow({
      content: contentString
    });
    function color(bikes) {
      if (bikes < 1) {
        return "red"
      }
      else if (bikes < 3) {
        return "orange"
      }
      else if (bikes < 6) {
        return "yellow"
      }
      else {
        return "green"
      }
    }

    google.maps.event.addListener(marker, 'click', function () {
    try{
      lastWindow.close();
    }catch(err)
    {
      //no window was open yet
    }
      infoWindow.open(map, marker);
      lastWindow = infoWindow;
    });
  };

  this.loadMarkers = function () {
    $.getJSON("/kiosk_data", function (data) {
      that.kiosks = data;
      $.each(that.kiosks, function (index, value) {
        var kiosk = value.fields;
        that.addMarker(kiosk);
      });
    });
  };


  this.codeAddress = function () {
    var address = document.getElementById("address").value;
    this.geocoder.geocode({
      'address': address
    }, function (results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  };
  return this;
}();
$(document).ready(function () {
  $("#search_button").click(function () {
    googleMap.codeAddress();
  });
  $("#search_form").submit(function () {
    googleMap.codeAddress();
    return false; //do not actually submit the form (stay on same page)
  });
  googleMap.initialize();
});


</script> 
</head> 
<body>
<div id="map_canvas"></div> 
<div id="container"> 
  <div id="legend">
    SEVICI MAPA
  </div>
  <form id="search_form">
   <input id="address" type="textbox" value="Sevilla"> 
   <input id="search_button" type="submit" value="Go">
  </form>
</div>

<script type="text/javascript">
  var uservoiceOptions = {
    key: 'sevicimapa',
    host: 'sevicimapa.uservoice.com', 
    forum: '70579',
    alignment: 'right',
    background_color:'#FF0000', 
    text_color: 'white',
    hover_color: '#0066CC',
    lang: 'es',
    showTab: true
  };
  function _loadUserVoice() {
    var s = document.createElement('script');
    s.src = ("https:" == document.location.protocol ? "https://" : "http://") + "uservoice.com/javascripts/widgets/tab.js";
    document.getElementsByTagName('head')[0].appendChild(s);
  }
  _loadSuper = window.onload;
  window.onload = (typeof window.onload != 'function') ? _loadUserVoice : function() { _loadSuper(); _loadUserVoice(); };
</script>

</body> 
</html>
