<!DOCTYPE html> 
<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>SEVILLA BICIS</title> 
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" /> 
<link href="{{MEDIA_URL}}css/map.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script> 
<script type="text/javascript"> 
var google;
var googleMap = function () {
	var that = this;
  var map;
	var geocoder;
  this.initialize = function () {
    this.geocoder = new google.maps.Geocoder();
		var center = new google.maps.LatLng(37.390891, - 5.987549);
    var myOptions = {
      zoom: 14,
      center: center,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		this.loadMarkers();
	};
	
	this.addMarker = function(lat,lng, name, spaces, bikes){
		var latlng = new google.maps.LatLng(lat,lng);
		var marker = new google.maps.Marker({
      position: latlng, 
      map: map, 
      title:name
	  });
		
		var contentString = "<div class='marker_title'>" + name + "</div>" +
		"<div class='marker_content'>"+
		"<p>bikes available: " + bikes + "</p>" +
 		"<p>spaces available: " + spaces + "</p>";

		var infowindow = new google.maps.InfoWindow({
	    content: contentString
		});

		google.maps.event.addListener(marker, 'click', function() {
		  infowindow.open(map,marker);
		});
	};
	
	this.loadMarkers = function () {
	  $.getJSON("/kiosk_data", function (data) {
	    that.kiosks = data;
	    $.each(that.kiosks, function (index, value) {
	      var k = value.fields;
	      that.addMarker(k.lat, k.lng, k.name, k.spaces, k.bikes);
	    });
	  });
	};


  this.codeAddress = function () {
    var address = document.getElementById("address").value;
    this.geocoder.geocode({
      'address': address
    }, function (results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
        });
      } else {
        alert("Geocode was not successful	for the following reason: " + status);
      }
    });
  };
  return this;
}();
$(document).ready(function () {
  $("#search_button").click(function () {
    googleMap.codeAddress();
  });
	$("#search_form").submit(function(){
		googleMap.codeAddress();
		return false; //do not actually submit the form (stay on same page)
	});
	googleMap.initialize();
});


</script> 
</head> 
<body>
<div id="map_canvas"></div> 
<div id="container"> 
	<div id="legend">
		SEVILLA
	</div>
	<form id="search_form">
	 <input id="address" type="textbox" value="Sevilla"> 
   <input id="search_button" type="submit" value="Go">
	</form>
</div>
</body> 
</html>